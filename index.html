<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Modem Configuration Visualizer</title>
    <link rel="icon" href="https://raw.githubusercontent.com/pgarciafer/MTNmodem/main/logo1.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                DEFAULT: '#005A9C',
                hover: '#004a80',
              },
              danger: '#dc3545',
              success: '#28a745',
            }
          }
        }
      }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script type="importmap">
      {
        "imports": {
          "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
          "react/": "https://aistudiocdn.com/react@^19.2.0/",
          "react": "https://aistudiocdn.com/react@^19.2.0"
        }
      }
    </script>
  </head>
  <body class="bg-white text-gray-800">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
      import React, { useState, useCallback, useEffect, useMemo, useRef } from 'react';
      import ReactDOM from 'react-dom/client';

      // --- All components and logic are now in this script tag ---

      const handleAntimeridianCrossing = (points) => {
        if (!points || points.length < 2) return points;
        
        const unwrappedPoints = [[points[0][0], points[0][1]]];
        
        for (let i = 1; i < points.length; i++) {
            const prevLon = unwrappedPoints[i-1][1];
            const currentLat = points[i][0];
            let currentLon = points[i][1];

            if (prevLon - currentLon > 180) {
                currentLon += 360;
            } else if (currentLon - prevLon > 180) {
                currentLon -= 360;
            }
            
            unwrappedPoints.push([currentLat, currentLon]);
        }
        
        return unwrappedPoints;
      };

      const FileUpload = ({ slotLabel, onFileUpload, fileName, onReset, setError }) => {
        const handleFileChange = (event) => {
          setError(null);
          const files = event.target.files;
          if (files && files.length > 0) {
            onFileUpload(files);
          }
          event.target.value = '';
        };

        const handleDragOver = (event) => {
          event.preventDefault();
        };

        const handleDrop = (event) => {
          event.preventDefault();
          setError(null);
          const files = event.dataTransfer.files;
          if (files && files.length > 0) {
            onFileUpload(files);
          }
        };

        if (fileName) {
            return (
                <div className="relative w-full rounded-lg border-2 border-green-300 p-6 text-center bg-green-50">
                    <h3 className="text-lg font-bold text-gray-800">{slotLabel}</h3>
                    <p className="mt-2 text-sm font-medium text-green-800 truncate" title={fileName}>{fileName}</p>
                    <button onClick={onReset} className="absolute top-2 right-2 text-2xl font-bold text-gray-400 hover:text-danger">&times;</button>
                </div>
            )
        }

        return (
          <div className="w-full mx-auto">
            <h3 className="text-lg font-bold text-gray-800 mb-2 text-center">{slotLabel}</h3>
            <label
              htmlFor={`file-upload-${slotLabel}`}
              className="relative block w-full h-56 rounded-lg border-2 border-dashed border-gray-300 p-12 text-center hover:border-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary/50 cursor-pointer bg-gray-100 transition-colors"
              onDragOver={handleDragOver}
              onDrop={handleDrop}
            >
              <svg
                className="mx-auto h-12 w-12 text-gray-400"
                stroke="currentColor"
                fill="none"
                viewBox="0 0 24 24"
              >
                 <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
              </svg>
              <span className="mt-2 block text-sm font-medium text-gray-600">
                Drop <span className="text-primary">.zip</span> or <span className="text-primary">.json</span> file
              </span>
              <span className="mt-1 block text-xs text-gray-500">or click to browse</span>
              <input
                id={`file-upload-${slotLabel}`}
                type="file"
                multiple
                accept=".zip,.json,application/zip,application/x-zip-compressed,application/json"
                className="sr-only"
                onChange={handleFileChange}
              />
            </label>
          </div>
        );
      };
      
      const vlanColorStyles = {
        '1': {
            bg: 'bg-green-100',
            border: 'border-green-400',
            text: 'text-green-800',
            led: 'bg-green-500 shadow-[0_0_5px_1px_rgba(34,197,94,0.7)]',
            hex: '#4ade80'
        },
        '900': {
            bg: 'bg-sky-100',
            border: 'border-sky-400',
            text: 'text-sky-800',
            led: 'bg-sky-500 shadow-[0_0_5px_1px_rgba(14,165,233,0.7)]',
            hex: '#38bdf8'
        },
        'default': {
            bg: 'bg-gray-100',
            border: 'border-gray-400',
            text: 'text-gray-800',
            led: 'bg-gray-500 shadow-[0_0_5px_1px_rgba(107,114,128,0.7)]',
            hex: '#9ca3af'
        }
      };

      const LanPortIcon = ({ className }) => (
        <img src="https://raw.githubusercontent.com/pgarciafer/MTNmodem/main/lanport.png" alt="LAN Port" className={className} />
      );

      const ModemSchematic = ({ config }) => {
        const ports = config.SWITCH_PORT;
        const vlanConfigs = config.VLAN_CONFIGURATIONS;
        const sortedPorts = [...ports].sort((a, b) => a.port_number - b.port_number);

        const is8PortLayout = sortedPorts.length === 8;

        const topRowPorts = is8PortLayout
          ? sortedPorts.filter(p => p.port_number % 2 === 0)
          : [];
        const bottomRowPorts = is8PortLayout
          ? sortedPorts.filter(p => p.port_number % 2 !== 0)
          : sortedPorts;

        const Port = ({ port }) => {
            const vlanList = port.terminal_vid_list;
            const isMultiVlan = vlanList.length > 1;
            
            const ipAddressesInfo = vlanList.map(vlanId => {
                const vlanInfo = vlanConfigs.find(v => v.vid === vlanId);
                const ip = vlanInfo?.IP_INTERFACES?.[0]?.address || 'N/A';
                return { vlan: vlanId, ip };
            });
            const vlanListString = vlanList.join(', ');

            let portStyle = {};
            let portClasses = 'group relative rounded-lg p-2 border-2 text-center transition-all w-full flex flex-col justify-between items-center min-h-[6rem] hover:scale-105 hover:shadow-xl hover:border-primary';
            let ledClasses = 'w-2 h-2 rounded-full animate-pulse';

            if (isMultiVlan) {
                const gradientColors = vlanList
                    .map(vlan => vlanColorStyles[vlan]?.hex || vlanColorStyles.default.hex);
                
                portStyle.background = gradientColors.length > 1
                    ? `linear-gradient(45deg, ${gradientColors.join(', ')})`
                    : `solid ${gradientColors[0] || vlanColorStyles.default.hex}`;

                portClasses += ' border-primary text-gray-800';
                ledClasses += ' bg-white shadow-[0_0_5px_1px_rgba(255,255,255,0.7)]';
            } else {
                const singleVlan = String(vlanList[0] || 'default');
                const styles = vlanColorStyles[singleVlan] || vlanColorStyles.default;
                portClasses += ` ${styles.bg} ${styles.border} ${styles.text}`;
                ledClasses += ` ${styles.led}`;
            }

            return (
                <div className={portClasses} style={portStyle}>
                    <div className="w-full flex justify-between items-center">
                        <div className={ledClasses}></div>
                        <div className="text-xs font-mono text-gray-500">P{port.port_number}</div>
                    </div>

                    <LanPortIcon className="w-10 h-10 sm:w-12 sm:h-12 my-1"/>
                    
                    <div className="text-sm font-semibold">{isMultiVlan ? 'VLANs' : 'VLAN'} {vlanListString}</div>

                    <div className="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 w-max max-w-xs bg-white text-gray-700 text-xs rounded-lg shadow-lg p-2 border border-gray-200 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                        <dl className="space-y-1">
                          {ipAddressesInfo.map(({ vlan, ip }) => (
                            <div key={vlan} className="flex justify-between items-start gap-4">
                                <dt className="text-gray-500 flex-shrink-0">VLAN {vlan} IP:</dt>
                                <dd className="font-semibold font-mono">{ip}</dd>
                            </div>
                          ))}
                        </dl>
                        <div className="absolute left-1/2 -translate-x-1/2 bottom-[-4px] w-2 h-2 bg-white transform rotate-45 border-b border-r border-gray-200"></div>
                    </div>
                </div>
            );
        };

        return (
          <div className="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
            <h2 className="text-xl font-bold text-gray-700 mb-4">Modem Schematic</h2>
            <div className="bg-gray-50 rounded-lg p-4">
              <div className="flex flex-col justify-center gap-2 md:gap-4 w-full">
                {is8PortLayout && (
                  <div className="grid grid-cols-4 gap-2 md:gap-4">
                    {topRowPorts.map((port) => <Port key={port.port_number} port={port} />)}
                  </div>
                )}
                <div className="grid grid-cols-4 gap-2 md:gap-4">
                  {bottomRowPorts.map((port) => <Port key={port.port_number} port={port} />)}
                </div>
              </div>
            </div>
          </div>
        );
      };

      const DetailItem = ({ label, value, className = '' }) => (
        <div className={`flex justify-between items-start py-2 border-b border-gray-200 ${className}`}>
          <dt className="text-sm text-gray-500 truncate pr-2">{label}</dt>
          <dd className="text-sm font-semibold text-gray-800 text-right">{value}</dd>
        </div>
      );

      const StatusPill = ({ enabled }) => (
          enabled ? 
          <span className="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Enabled</span> :
          <span className="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Disabled</span>
      );

      const DhcpDetails = ({ dhcpConfig }) => (
          <>
              <h4 className="font-semibold text-gray-600 mt-4 mb-2">DHCPv4 Configuration</h4>
              <dl>
                  <DetailItem label="Status" value={<StatusPill enabled={dhcpConfig.dhcp_enable === 1} />} />
                  <DetailItem label="Gateway" value={<code className="text-sm">{dhcpConfig.dhcp_gateway_ip}</code>} />
                  <DetailItem label="Subnet" value={<code className="text-sm">{dhcpConfig.dhcp_subnet}</code>} />
                  <DetailItem label="Netmask" value={<code className="text-sm">{dhcpConfig.dhcp_netmask}</code>} />
                  <DetailItem label="Lease Range" value={<code className="text-sm">{dhcpConfig.dhcp_lease_range}</code>} />
                  <DetailItem label="Primary DNS" value={<code className="text-sm">{dhcpConfig.dhcp_primary_dns_address}</code>} />
                  <DetailItem label="Secondary DNS" value={<code className="text-sm">{dhcpConfig.dhcp_secondary_dns_address}</code>} />
              </dl>
          </>
      );

      const VlanCard = ({ vlanConfig }) => (
          <div className="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
              <h3 className="text-lg font-bold text-primary mb-3">VLAN Configuration: <span className="text-gray-900">{vlanConfig.vid}</span></h3>
              
              <h4 className="font-semibold text-gray-600 mb-2">IP Interfaces</h4>
              {vlanConfig.IP_INTERFACES.map((iface, index) => (
                  <div key={index} className="bg-gray-50 p-3 rounded-md mb-2">
                      <dl>
                          <DetailItem label="Interface" value={iface.interface} className="border-none py-1" />
                          <DetailItem label="Address" value={<code className="text-sm">{iface.address}</code>} className="border-none py-1" />
                          <DetailItem label="Netmask" value={<code className="text-sm">{iface.netmask}</code>} className="border-none py-1" />
                          <DetailItem label="Gateway" value={<code className="text-sm">{iface.gateway}</code>} className="border-none py-1" />
                      </dl>
                  </div>
              ))}
              
              {vlanConfig.DHCPV4 && <DhcpDetails dhcpConfig={vlanConfig.DHCPV4} />}
          </div>
      );

      const ConfigurationSummary = ({ config }) => {
        return (
          <div className="space-y-6">
             <div className="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
               <h3 className="text-lg font-bold text-primary mb-3">General Information</h3>
               <dl>
                 <DetailItem label="Element Type" value={config.NMS.type} />
                 <DetailItem label="Element ID" value={config.NMS.element_id} />
                 <DetailItem label="Parent ID" value={config.NMS.element_parent_id} />
                 <DetailItem label="L2 Switch Enabled" value={<StatusPill enabled={config.L2SW.enabled === 1} />} />
               </dl>
             </div>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {config.VLAN_CONFIGURATIONS.sort((a, b) => a.vid - b.vid).map((vlanConfig) => (
                  <VlanCard key={vlanConfig.vid} vlanConfig={vlanConfig} />
                ))}
            </div>
          </div>
        );
      };

      const CollapsibleCard = ({ title, children, defaultOpen = false, className = '' }) => {
        const [isOpen, setIsOpen] = useState(defaultOpen);

        return (
          <div className={`bg-white rounded-lg shadow-sm border border-gray-200 ${className}`}>
            <button
              onClick={() => setIsOpen(!isOpen)}
              className="w-full flex justify-between items-center p-4 text-left focus:outline-none focus:ring-2 focus:ring-inset focus:ring-primary/50"
              aria-expanded={isOpen}
            >
              <h3 className="text-lg font-bold text-primary">{title}</h3>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                className={`h-6 w-6 transform transition-transform duration-200 text-gray-400 ${isOpen ? 'rotate-180' : ''}`}
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
              </svg>
            </button>
            {isOpen && (
              <div className="p-4 pt-0">
                <div className="border-t border-gray-200 pt-4">
                  {children}
                </div>
              </div>
            )}
          </div>
        );
      };

      const OptConfigurationSummary = ({ config }) => {
        const [keyInfo, setKeyInfo] = useState([]);

        useEffect(() => {
            if (!config) return;

            const findKeyInfo = (data) => {
                const info = [];
                 const searchTerms = {
                    'Model': /(^|_)model(_| |)type$/i,
                    'Serial Number': /(^|_)serial(_number|\s+number|)?$|sn$/i,
                };

                const traverse = (obj) => {
                    if (obj === null || typeof obj !== 'object') return;

                    for (const key in obj) {
                        if (Object.prototype.hasOwnProperty.call(obj, key)) {
                            const value = obj[key];
                            
                            for (const label in searchTerms) {
                                if (searchTerms[label].test(key) && (typeof value === 'string' || typeof value === 'number') && value) {
                                     if (!info.some(i => i.label === label)) {
                                        info.push({ label, value: String(value) });
                                    }
                                }
                            }

                             if (key.toUpperCase() === 'AIM' && typeof value === 'object' && value !== null) {
                                for (const aimKey in value) {
                                    if (/ip|address/i.test(aimKey)) {
                                        const addressValue = String(value[aimKey]);
                                        const parts = addressValue.split(';').map(p => p.trim());
                                        const ipPart = parts.find(p => /\d+\.\d+\d+\.\d+/.test(p));
                                        const portPart = parts.find(p => /^\d+$/.test(p) && p !== ipPart && parseInt(p, 10) > 0);
                                        if (ipPart) {
                                            const finalValue = portPart ? `${ipPart}:${portPart}` : ipPart;
                                            if (!info.some(i => i.label === 'AIM Address')) {
                                               info.push({ label: 'AIM Address', value: finalValue });
                                            }
                                            break; 
                                        }
                                    }
                                }
                            }
                            
                            if (typeof value === 'object') {
                                traverse(value);
                            }
                        }
                    }
                };

                traverse(data);
                return info;
            };
            
            const rawInfo = findKeyInfo(config);
            const uniqueInfo = Array.from(new Map(rawInfo.map(item => [item.label, item])).values());
                    
            const modelInfo = uniqueInfo.find(item => item.label === 'Model');
            const snInfo = uniqueInfo.find(item => item.label === 'Serial Number');
            const otherInfo = uniqueInfo.filter(item => item.label !== 'Model' && item.label !== 'Serial Number');

            const combinedInfo = [];
             if (modelInfo && snInfo) {
                combinedInfo.push({ label: 'Device', value: `${modelInfo.value} (SN: ${snInfo.value})` });
            } else if (modelInfo) {
                combinedInfo.push({ label: 'Device', value: modelInfo.value });
            } else if (snInfo) {
                 combinedInfo.push({label: 'Serial Number', value: snInfo.value });
            }
            
            setKeyInfo([...combinedInfo, ...otherInfo]);
        }, [config]);


        if (!config || typeof config !== 'object' || Object.keys(config).length === 0) {
            return (
                <div className="bg-white rounded-lg p-6 shadow-sm border border-gray-200 text-center">
                    <h3 className="text-lg font-bold text-gray-500 mb-2">No Data to Display</h3>
                    <p className="text-gray-500">The configuration file is empty or could not be parsed as a valid object.</p>
                </div>
            );
        }

        const renderValue = (value) => {
            if (typeof value === 'boolean') return <StatusPill enabled={value} />;
            if (value === null) return <code className="text-sm text-gray-500">null</code>;
            if (Array.isArray(value)) {
                if (value.every(item => typeof item !== 'object' || item === null)) {
                    return <code className="text-sm break-all">{value.join(', ')}</code>;
                }
                return (
                    <div className="space-y-2">
                        {value.map((item, index) => (
                            <div key={index} className="bg-gray-100 p-3 rounded-md">
                                <pre className="text-xs text-gray-800 overflow-x-auto whitespace-pre-wrap break-all">
                                    {JSON.stringify(item, null, 2)}
                                </pre>
                            </div>
                        ))}
                    </div>
                );
            }
            if (typeof value === 'object') {
                 return (
                    <pre className="mt-1 text-left bg-gray-100 p-3 rounded-md overflow-x-auto text-xs text-gray-800 whitespace-pre-wrap break-all">
                        {JSON.stringify(value, null, 2)}
                    </pre>
                );
            }
            return <code className="text-sm break-all">{String(value)}</code>;
        };

        const renderDetailItem = (key, value) => {
            const formattedKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            const isBlock = typeof value === 'object' && value !== null;

            if (isBlock) {
                 return (
                    <div key={key} className="py-2 border-b border-gray-200">
                        <dt className="text-sm text-gray-500">{formattedKey}</dt>
                        <dd className="mt-1">{renderValue(value)}</dd>
                    </div>
                 );
            }
            return <DetailItem key={key} label={formattedKey} value={renderValue(value)} />;
        };

        const entries = Object.entries(config);
        const objectEntries = entries.filter(([, v]) => typeof v === 'object' && v !== null && !Array.isArray(v));
        const arrayEntries = entries.filter(([, v]) => Array.isArray(v));
        const primitiveEntries = entries.filter(([, v]) => typeof v !== 'object' || v === null);

        return (
            <div className="space-y-6">
                {keyInfo.length > 0 && (
                    <div className="bg-gradient-to-br from-blue-100 to-gray-50 rounded-lg p-6 shadow-sm border border-primary/50">
                        <h3 className="text-xl font-bold text-primary mb-4 flex items-center gap-x-2">
                            Key Information
                        </h3>
                        <dl className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-3">
                            {keyInfo.map(({ label, value }) => (
                                <div key={label} className="flex flex-col">
                                    <dt className="text-sm text-gray-500">{label}</dt>
                                    <dd className="text-lg font-semibold text-gray-900 font-mono break-all">{value}</dd>
                                </div>
                            ))}
                        </dl>
                    </div>
                )}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {primitiveEntries.length > 0 && (
                        <CollapsibleCard title="General Parameters" defaultOpen={true} className="md:col-span-1">
                            <dl>
                                {primitiveEntries.map(([key, value]) => renderDetailItem(key, value))}
                            </dl>
                        </CollapsibleCard>
                    )}
                    {objectEntries.map(([key, value]) => {
                        const formattedTitle = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        return (
                            <CollapsibleCard key={key} title={formattedTitle} className="md:col-span-1">
                                <dl>
                                    {Object.entries(value).map(([subKey, subValue]) => renderDetailItem(subKey, subValue))}
                                </dl>
                            </CollapsibleCard>
                        );
                    })}
                </div>
                {arrayEntries.length > 0 && (
                     <div className="space-y-6">
                         {arrayEntries.map(([key, value]) => {
                             const formattedTitle = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                             return (
                                <CollapsibleCard key={key} title={formattedTitle}>
                                    {renderValue(value)}
                                </CollapsibleCard>
                             );
                        })}
                     </div>
                )}
            </div>
        );
      };

      const ConstellationVisualizer = ({ config, formatLongitude }) => {
        const [searchTerm, setSearchTerm] = useState('');
        const [isResultsOpen, setIsResultsOpen] = useState(false);
        const [selectedLongitude, setSelectedLongitude] = useState('');
        const [selectedBeamId, setSelectedBeamId] = useState(null);
        
        const mapRef = useRef(null);
        const beamsDataRef = useRef({});
        const layersRef = useRef({});

        useEffect(() => {
            if (!mapRef.current) {
                mapRef.current = L.map('map', {
                    worldCopyJump: true
                }).setView([0, 0], 2);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd',
                    maxZoom: 20
                }).addTo(mapRef.current);
            }
        }, []);

        useEffect(() => {
            if (mapRef.current) {
                // When the view is shown or updated, the map container might need its size re-calculated.
                // A short delay ensures the DOM has settled.
                setTimeout(() => {
                    mapRef.current.invalidateSize();
                }, 100);
            }
        }); // No dependency array, runs on every render to catch layout changes

        const { satelliteGroups } = useMemo(() => {
            if (!config?.CONSTELLATION?.SATELLITES) return { satelliteGroups: {} };
            
            const filteredSatellites = config.CONSTELLATION.SATELLITES.filter(s => 
                s.satellite_id && !String(s.satellite_id).toLowerCase().startsWith('test')
            );

            const groups = filteredSatellites.reduce((acc, satellite) => {
                const lon = satellite.longitude;
                if (!acc[lon]) {
                    acc[lon] = { names: new Set(), beams: [] };
                }
                acc[lon].names.add(satellite.satellite_id);

                if (satellite.BEAM && satellite.CARRIER) {
                    satellite.BEAM.forEach(beam => {
                        const carriers = satellite.CARRIER.filter(c => c.beam_id === beam.beam_id);
                        if (carriers.length > 0) {
                            acc[lon].beams.push({
                                ...beam,
                                uniqueId: `${satellite.satellite_id}-${beam.beam_id}`,
                                satellite_name: satellite.satellite_id,
                                satellite_longitude: satellite.longitude,
                                carriers: carriers,
                            });
                        }
                    });
                }
                return acc;
            }, {});

            Object.values(groups).forEach(group => {
                group.beams.sort((a,b) => a.beam_id - b.beam_id);
            });
            
            return { satelliteGroups: groups };
        }, [config]);

        const filteredSatelliteGroups = useMemo(() => {
            if (!searchTerm) {
                return satelliteGroups;
            }
            const lowerCaseSearch = searchTerm.toLowerCase();
            const filtered = {};

            for (const lon in satelliteGroups) {
                const group = satelliteGroups[lon];
                const namesMatch = Array.from(group.names).some(name => name.toLowerCase().includes(lowerCaseSearch));
                const lonString = String(lon);
                const formattedLon = formatLongitude(parseFloat(lon)).toLowerCase();
                const lonMatch = lonString.includes(lowerCaseSearch) || formattedLon.includes(lowerCaseSearch);

                if (namesMatch || lonMatch) {
                    filtered[lon] = group;
                }
            }
            return filtered;
        }, [searchTerm, satelliteGroups, formatLongitude]);

        useEffect(() => {
            const map = mapRef.current;
            if (!config || !map) return;
        
            Object.values(layersRef.current).forEach(layer => {
                if (map.hasLayer(layer)) {
                    map.removeLayer(layer);
                }
            });
            layersRef.current = {};
            beamsDataRef.current = {};
        
            const allBeams = {};
            const filteredSatellites = config.CONSTELLATION.SATELLITES.filter(s => 
                s.satellite_id && !String(s.satellite_id).toLowerCase().startsWith('test')
            );
            
            filteredSatellites.forEach(satellite => {
                if (satellite.BEAM && satellite.CARRIER) {
                    satellite.BEAM.forEach(beam => {
                        const carriers = satellite.CARRIER.filter(c => c.beam_id === beam.beam_id);
                        if (carriers.length > 0) {
                            const uniqueId = `${satellite.satellite_id}-${beam.beam_id}`;
                            allBeams[uniqueId] = {
                                ...beam,
                                uniqueId: uniqueId,
                                satellite_name: satellite.satellite_id,
                                satellite_longitude: satellite.longitude,
                                carriers: carriers,
                            };
                        }
                    });
                }
            });
            beamsDataRef.current = allBeams;
        
            const newLayers = {};
            Object.values(allBeams).forEach(beamData => {
                const style = { color: "#D97706", weight: 2, opacity: 0.8, fillColor: "#FBBF24", fillOpacity: 0.2 };
                let originalGeometryLayer = null;
                const allGeometries = [];
                
                (beamData.CONTOUR || []).forEach(contour => {
                    if (contour.type === 1 && contour.points) {
                        const validPoints = contour.points.filter(p => Array.isArray(p) && p.length === 2 && !isNaN(p[0]) && !isNaN(p[1]));
                        if (validPoints.length < 3) return;
        
                        const antimeridianFixedPoints = handleAntimeridianCrossing(validPoints);
                        
                        const createPolygon = (points, shift) => L.polygon(points.map(p => [p[0], p[1] + shift]), style);
                        
                        if (!originalGeometryLayer) originalGeometryLayer = createPolygon(antimeridianFixedPoints, 0);
                        allGeometries.push(createPolygon(antimeridianFixedPoints, 0), createPolygon(antimeridianFixedPoints, -360), createPolygon(antimeridianFixedPoints, 360));
        
                    } else if (contour.type === 0 && contour.center && contour.radius) {
                        const center = [contour.center[0], contour.center[1]];
                        const radius = contour.radius * 1000;
                        if(radius > 0) {
                             const createCircle = (center, shift) => L.circle([center[0], center[1] + shift], { ...style, radius });
                             if (!originalGeometryLayer) originalGeometryLayer = createCircle(center, 0);
                             allGeometries.push(createCircle(center, 0), createCircle(center, -360), createCircle(center, 360));
                        }
                    }
                });
                
                if (allGeometries.length > 0) {
                    const group = L.featureGroup(allGeometries);
                    if (originalGeometryLayer) {
                        group.originalBounds = originalGeometryLayer.getBounds();
                    }
                    newLayers[beamData.uniqueId] = group;
                }
            });
            
            layersRef.current = newLayers;
            setSelectedLongitude('');
            setSelectedBeamId(null);
        
        }, [config]);

        useEffect(() => {
            const map = mapRef.current;
            const currentLayers = layersRef.current;
            if (!map || !currentLayers) return;
    
            Object.values(currentLayers).forEach(layer => {
                if (map.hasLayer(layer)) {
                    map.removeLayer(layer);
                }
            });
    
            const selectedLayer = currentLayers[selectedBeamId];
    
            if (selectedLayer) {
                selectedLayer.addTo(map);
                if (selectedLayer.originalBounds && selectedLayer.originalBounds.isValid()) {
                    map.fitBounds(selectedLayer.originalBounds, { padding: [50, 50], maxZoom: 5 });
                } else {
                    try {
                        const bounds = selectedLayer.getBounds();
                        if (bounds.isValid()) {
                            map.fitBounds(bounds, { padding: [50, 50], maxZoom: 5 });
                        }
                    } catch(e) {
                        console.error("Could not get bounds for layer", e);
                    }
                }
            }
        }, [selectedBeamId]);

        const selectedGroup = satelliteGroups[selectedLongitude];
        const selectedBeam = beamsDataRef.current[selectedBeamId] || null;

        return (
            <div className="space-y-6">
                 <div className="max-w-md space-y-2">
                    <label htmlFor="satellite-search" className="block text-sm font-medium text-gray-600">Search Satellite</label>
                     <div className="relative">
                         <div className="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                              <svg className="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fillRule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clipRule="evenodd" />
                              </svg>
                         </div>
                        <input
                            type="text"
                            id="satellite-search"
                            autoComplete="off"
                            value={searchTerm}
                            onChange={(e) => {
                                setSearchTerm(e.target.value);
                                setSelectedLongitude('');
                                setSelectedBeamId(null);
                                setIsResultsOpen(true);
                            }}
                            onFocus={(e) => {
                                setIsResultsOpen(true);
                                e.target.select();
                            }}
                            onBlur={() => {
                                // Delay hiding to allow click events on results to fire
                                setTimeout(() => setIsResultsOpen(false), 200);
                            }}
                            placeholder="Search by name or longitude..."
                            className="block w-full rounded-md border-gray-300 bg-white text-gray-800 pl-10 py-2 shadow-sm focus:border-primary focus:ring-primary sm:text-sm"
                        />
                        {isResultsOpen && (
                            <div className="absolute z-10 mt-1 w-full max-h-60 overflow-y-auto rounded-md bg-white py-1 text-base shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none sm:text-sm">
                                {Object.entries(filteredSatelliteGroups).length > 0 ? (
                                    Object.entries(filteredSatelliteGroups)
                                        .sort((a,b) => parseFloat(a[0]) - parseFloat(b[0]))
                                        .map(([lon, group]) => {
                                            const displayText = `${Array.from(group.names).join(' / ')} (${formatLongitude(parseFloat(lon))})`;
                                            return (
                                                <button
                                                    key={lon}
                                                    onMouseDown={() => { // use onMouseDown to fire before onBlur
                                                        setSelectedLongitude(lon);
                                                        setSearchTerm(displayText);
                                                        setIsResultsOpen(false);
                                                        setSelectedBeamId(null);
                                                    }}
                                                    className="w-full text-left cursor-pointer select-none relative py-2 pl-3 pr-9 text-gray-900 hover:bg-primary hover:text-white"
                                                >
                                                    {displayText}
                                                </button>
                                            );
                                        })
                                ) : (
                                    <div className="cursor-default select-none relative py-2 px-4 text-gray-700">No results found.</div>
                                )}
                            </div>
                        )}
                     </div>
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div className="space-y-6">
                        {selectedGroup && (
                            <div className="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
                                <h3 className="text-lg font-bold text-primary mb-3">Available Beams</h3>
                                <div className="max-h-60 overflow-y-auto pr-2 space-y-2">
                                    {selectedGroup.beams.map(beam => (
                                        <button 
                                            key={beam.uniqueId}
                                            onClick={() => setSelectedBeamId(beam.uniqueId)}
                                            className={`w-full text-left p-2 rounded-md transition-colors ${selectedBeamId === beam.uniqueId ? 'bg-primary/10 text-primary' : 'hover:bg-gray-100'}`}
                                        >
                                            <span className="font-semibold">Beam ID: {beam.beam_id}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}
                        {selectedBeam && (
                            <div className="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
                                <h3 className="text-lg font-bold text-primary mb-3">Beam Summary</h3>
                                <dl>
                                    <DetailItem label="Satellite Name" value={selectedBeam.satellite_name} />
                                    <DetailItem label="Satellite Longitude" value={formatLongitude(selectedBeam.satellite_longitude)} />
                                    <DetailItem label="Beam ID" value={selectedBeam.beam_id} />
                                    {selectedBeam.carriers && selectedBeam.carriers.map((carrier, index) => (
                                        <React.Fragment key={index}>
                                           <div className="pt-2 mt-2 border-t border-gray-200">
                                              <DetailItem label={`Polarization`} value={carrier.polarization} className="border-none"/>
                                              <DetailItem label={`Center Freq`} value={`${(carrier.center_freq / 1000).toFixed(2)} KHz`} className="border-none"/>
                                              <DetailItem label={`Symbol Rate`} value={carrier.symbol_rate} className="border-none"/>
                                           </div>
                                        </React.Fragment>
                                    ))}
                                </dl>
                            </div>
                        )}
                    </div>
                    <div className="min-h-[24rem]">
                        <div id="map" className="w-full h-96 md:h-full rounded-lg bg-gray-200 border border-gray-300 shadow-lg"></div>
                    </div>
                </div>
            </div>
        );
      };

      const deepSortObject = (obj) => {
        if (typeof obj !== 'object' || obj === null) {
          return obj;
        }

        if (Array.isArray(obj)) {
          // First, recursively sort the elements of the array
          const sortedArray = obj.map(deepSortObject);
          
          // Then, if it's an array of objects, try to sort the array itself
          if (sortedArray.length > 0 && typeof sortedArray[0] === 'object' && sortedArray[0] !== null) {
            // Common keys to identify objects in an array
            const keyCandidates = ['id', 'vid', 'port_number', 'satellite_id', 'beam_id', 'terminal_vid'];
            
            // Find the first candidate key that exists in ALL objects of the array
            const sortKey = keyCandidates.find(key => 
              sortedArray.every(item => item && typeof item === 'object' && item.hasOwnProperty(key))
            );
            
            if (sortKey) {
              sortedArray.sort((a, b) => {
                // Handle numeric or string comparison
                if (a[sortKey] < b[sortKey]) return -1;
                if (a[sortKey] > b[sortKey]) return 1;
                return 0;
              });
            }
          }
          return sortedArray;
        }

        // For objects, sort by keys
        return Object.keys(obj).sort().reduce((result, key) => {
          result[key] = deepSortObject(obj[key]);
          return result;
        }, {});
      };

      const deepDiff = (obj1, obj2, path = '') => {
        const diff = [];
        const allKeys = new Set([...Object.keys(obj1 || {}), ...Object.keys(obj2 || {})]);
      
        allKeys.forEach(key => {
          const currentPath = path ? `${path}.${key}` : key;
          const val1 = obj1 ? obj1[key] : undefined;
          const val2 = obj2 ? obj2[key] : undefined;
      
          if (JSON.stringify(val1) === JSON.stringify(val2)) return;
      
          if (val1 === undefined) {
            diff.push({ type: 'ADDED', path: currentPath, value: val2 });
          } else if (val2 === undefined) {
            diff.push({ type: 'REMOVED', path: currentPath, value: val1 });
          } else if (typeof val1 === 'object' && val1 !== null && typeof val2 === 'object' && val2 !== null && !Array.isArray(val1) && !Array.isArray(val2)) {
            diff.push(...deepDiff(val1, val2, currentPath));
          } else {
            diff.push({ type: 'MODIFIED', path: currentPath, oldValue: val1, newValue: val2 });
          }
        });
      
        return diff;
      };
      
      const DiffValue = ({ value }) => (
        <pre className="text-xs p-1 rounded-md bg-gray-100 whitespace-pre-wrap break-all">{JSON.stringify(value, null, 2)}</pre>
      );
      
      const ComparisonView = ({ configA, configB, configType }) => {
        const differences = useMemo(() => deepDiff(configA, configB), [configA, configB]);
      
        if (differences.length === 0) {
          return (
            <div className="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-md" role="alert">
              <p className="font-bold">No Differences Found</p>
              <p>The two {configType} configurations are identical.</p>
            </div>
          );
        }
      
        return (
          <div className="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
            <h3 className="text-xl font-bold text-primary mb-4">Configuration Differences</h3>
            <div className="space-y-4">
              {differences.map((diff, index) => (
                <div key={index} className="p-3 rounded-lg border">
                  <strong className="text-sm font-mono text-gray-700 break-all">{diff.path}</strong>
                  {diff.type === 'MODIFIED' && (
                    <div className="mt-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <p className="text-xs text-red-600 font-semibold mb-1">A (Old Value)</p>
                        <div className="border border-red-200 rounded-md p-2"><DiffValue value={diff.oldValue} /></div>
                      </div>
                      <div>
                        <p className="text-xs text-green-600 font-semibold mb-1">B (New Value)</p>
                         <div className="border border-green-200 rounded-md p-2"><DiffValue value={diff.newValue} /></div>
                      </div>
                    </div>
                  )}
                  {diff.type === 'ADDED' && (
                     <div className="mt-2">
                        <p className="text-xs text-green-600 font-semibold mb-1">Added in B</p>
                        <div className="border border-green-200 rounded-md p-2"><DiffValue value={diff.value} /></div>
                    </div>
                  )}
                  {diff.type === 'REMOVED' && (
                    <div className="mt-2">
                        <p className="text-xs text-red-600 font-semibold mb-1">Removed from B</p>
                        <div className="border border-red-200 rounded-md p-2"><DiffValue value={diff.value} /></div>
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>
        );
      };

      const ConstellationComparison = ({ configA, configB, formatLongitude }) => {
          const satellitesA = useMemo(() => new Map((configA?.CONSTELLATION?.SATELLITES || []).map(s => [s.satellite_id, s])), [configA]);
          const satellitesB = useMemo(() => new Map((configB?.CONSTELLATION?.SATELLITES || []).map(s => [s.satellite_id, s])), [configB]);
          
          const comparison = useMemo(() => {
              if (!configA || !configB) return null;
      
              const added = [...satellitesB.keys()].filter(id => !satellitesA.has(id)).map(id => satellitesB.get(id));
              const removed = [...satellitesA.keys()].filter(id => !satellitesB.has(id)).map(id => satellitesA.get(id));
              const commonIds = [...satellitesA.keys()].filter(id => satellitesB.has(id));
      
              const modified = commonIds.map(id => {
                  const satA = satellitesA.get(id);
                  const satB = satellitesB.get(id);
                  const carrierKey = c => `${c.beam_id}-${c.center_freq}-${c.polarization}-${c.symbol_rate}`;
                  
                  const carriersA = new Map((satA.CARRIER || []).map(c => [carrierKey(c), c]));
                  const carriersB = new Map((satB.CARRIER || []).map(c => [carrierKey(c), c]));
      
                  const carriersAdded = [...carriersB.keys()].filter(k => !carriersA.has(k)).map(k => carriersB.get(k));
                  const carriersRemoved = [...carriersA.keys()].filter(k => !carriersB.has(k)).map(k => carriersA.get(k));
      
                  const satDiff = deepDiff(satA, satB);
                  const rootChanges = satDiff.filter(d => !d.path.startsWith('CARRIER') && !d.path.startsWith('BEAM'));

                  if (carriersAdded.length > 0 || carriersRemoved.length > 0 || rootChanges.length > 0) {
                      return { satellite_id: id, added: carriersAdded, removed: carriersRemoved, changes: rootChanges };
                  }
                  return null;
              }).filter(Boolean);
      
              return { added, removed, modified };
          }, [configA, configB, satellitesA, satellitesB]);
      
          if (!comparison || (comparison.added.length === 0 && comparison.removed.length === 0 && comparison.modified.length === 0)) {
               return (
                  <div className="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-md" role="alert">
                    <p className="font-bold">No Differences Found</p>
                    <p>The two CONSTELLATION_OPT configurations are identical.</p>
                  </div>
              );
          }
      
          const renderCarrier = (carrier) => (
             <div className="grid grid-cols-2 md:grid-cols-4 gap-x-4 gap-y-1 text-xs font-mono">
                <span>Beam: {carrier.beam_id}</span>
                <span>{carrier.polarization}</span>
                <span>{(carrier.center_freq/1000).toFixed(2)} KHz</span>
                <span>{carrier.symbol_rate}</span>
             </div>
          );
      
          return (
              <div className="space-y-6">
                  {comparison.added.length > 0 && (
                      <CollapsibleCard title="Added Satellites" defaultOpen={true}>
                          <div className="space-y-2">
                              {comparison.added.map(sat => <div key={sat.satellite_id} className="p-2 bg-green-50 border border-green-200 rounded">{sat.satellite_id} ({formatLongitude(sat.longitude)})</div>)}
                          </div>
                      </CollapsibleCard>
                  )}
                   {comparison.removed.length > 0 && (
                      <CollapsibleCard title="Removed Satellites" defaultOpen={true}>
                           <div className="space-y-2">
                              {comparison.removed.map(sat => <div key={sat.satellite_id} className="p-2 bg-red-50 border border-red-200 rounded">{sat.satellite_id} ({formatLongitude(sat.longitude)})</div>)}
                          </div>
                      </CollapsibleCard>
                  )}
                   {comparison.modified.length > 0 && (
                      <CollapsibleCard title="Modified Satellites" defaultOpen={true}>
                           <div className="space-y-4">
                              {comparison.modified.map(mod => {
                                  const sat = satellitesA.get(mod.satellite_id) || satellitesB.get(mod.satellite_id);
                                  return (
                                      <div key={mod.satellite_id}>
                                          <h4 className="font-bold text-gray-800">{mod.satellite_id} {sat ? `(${formatLongitude(sat.longitude)})` : ''}</h4>
                                          {mod.changes.length > 0 && (
                                            <div className="mt-2 text-sm">
                                                {mod.changes.map(change => (
                                                    <div key={change.path} className="flex gap-2 p-1 bg-yellow-50 border border-yellow-200 rounded">
                                                        <span className="font-semibold text-yellow-800">{change.path}:</span> 
                                                        <span className="text-red-600 line-through">{JSON.stringify(change.oldValue)}</span>
                                                        <span>&rarr;</span>
                                                        <span className="text-green-600">{JSON.stringify(change.newValue)}</span>
                                                    </div>
                                                ))}
                                            </div>
                                          )}
                                          {mod.added.length > 0 && (
                                              <div className="mt-2">
                                                  <p className="text-sm font-semibold text-green-700">Added Carriers:</p>
                                                  <div className="pl-4 space-y-1">{mod.added.map((c, i) => <div key={i} className="p-1 bg-green-50 rounded border border-green-200">{renderCarrier(c)}</div>)}</div>
                                              </div>
                                          )}
                                          {mod.removed.length > 0 && (
                                               <div className="mt-2">
                                                  <p className="text-sm font-semibold text-red-700">Removed Carriers:</p>
                                                  <div className="pl-4 space-y-1">{mod.removed.map((c, i) => <div key={i} className="p-1 bg-red-50 rounded border border-red-200">{renderCarrier(c)}</div>)}</div>
                                              </div>
                                          )}
                                      </div>
                                  );
                              })}
                          </div>
                      </CollapsibleCard>
                  )}
              </div>
          );
      };
      
      const LanComparisonView = ({ configA, configB }) => {
        const differences = useMemo(() => deepDiff(configA, configB), [configA, configB]);

        if (differences.length === 0) {
          return (
            <div>
              <div className="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-md mb-6" role="alert">
                <p className="font-bold">No Differences Found</p>
                <p>The two TERMINAL_LAN_OPT configurations are identical.</p>
              </div>
              <ModemSchematic config={configA} />
            </div>
          );
        }

        return (
          <div className="space-y-8">
            <div>
              <div className="flex items-center gap-4 mb-4">
                <h3 className="text-2xl font-bold text-gray-800">Configuration A</h3>
                <span className="text-sm font-medium text-red-600 bg-red-100 px-2 py-1 rounded-full">Old Value</span>
              </div>
              <ModemSchematic config={configA} />
            </div>
            
            <div className="border-t border-gray-200 my-8"></div>

            <div>
              <div className="flex items-center gap-4 mb-4">
                  <h3 className="text-2xl font-bold text-gray-800">Configuration B</h3>
                  <span className="text-sm font-medium text-green-600 bg-green-100 px-2 py-1 rounded-full">New Value</span>
              </div>
              <ModemSchematic config={configB} />
            </div>
          </div>
        );
      };

      const App = () => {
        const [configSetA, setConfigSetA] = useState({ lan: null, opt: null, constellation: null, fileName: '' });
        const [configSetB, setConfigSetB] = useState({ lan: null, opt: null, constellation: null, fileName: '' });
        const [error, setError] = useState(null);
        const [isLoading, setIsLoading] = useState(false);
        const [currentView, setCurrentView] = useState('upload'); // e.g., 'lanA', 'lanCompare'

        const formatLongitude = (lon) => {
            if (typeof lon !== 'number') return '';
            const direction = lon >= 0 ? 'E' : 'W';
            return `${Math.abs(lon).toFixed(1)} ${direction}`;
        };

        const unwrapJson = (jsonObject) => {
            const keys = Object.keys(jsonObject);
            if (keys.length === 1 && typeof jsonObject[keys[0]] === 'object' && jsonObject[keys[0]] !== null) {
                return jsonObject[keys[0]];
            }
            return jsonObject;
        };

        const handleFileUpload = useCallback(async (files, slot) => {
          setIsLoading(true);
          setError(null);

          const setConfig = slot === 'A' ? setConfigSetA : setConfigSetB;
          const currentConfig = slot === 'A' ? configSetA : configSetB;
          
          let newConfig = { ...currentConfig };
          let newFileNames = currentConfig.fileName ? currentConfig.fileName.split(', ').filter(Boolean) : [];

          for (const file of files) {
              if (newFileNames.includes(file.name)) continue;

              const isZip = file.name.toLowerCase().endsWith('.zip') || file.type.includes('zip');
              const isJson = file.name.toLowerCase().endsWith('.json') || file.type.includes('json');

              if (isZip) {
                  newFileNames.push(file.name);
                  try {
                      const zip = await JSZip.loadAsync(file);
                      
                      const lanFile = zip.file(/terminal_lan_opt\.json/i)[0];
                      if (lanFile) newConfig.lan = deepSortObject(unwrapJson(JSON.parse(await lanFile.async("string"))));

                      const optFile = zip.file(/terminal_opt\.json/i)[0];
                      if (optFile) newConfig.opt = deepSortObject(unwrapJson(JSON.parse(await optFile.async("string"))));

                      const constFile = zip.file(/constellation_opt\.json/i)[0];
                      if (constFile) newConfig.constellation = deepSortObject(JSON.parse(await constFile.async("string")));
                      
                  } catch (err) {
                      setError(prev => `${prev ? prev + '\n' : ''}Failed to process ${file.name}: ${err.message}`);
                      newFileNames = newFileNames.filter(name => name !== file.name);
                  }
              } else if (isJson) {
                  newFileNames.push(file.name);
                  try {
                      const jsonText = await file.text();
                      const parsedJson = JSON.parse(jsonText);
                      const sortedJson = deepSortObject(parsedJson);

                      if (sortedJson?.CONSTELLATION?.SATELLITES) {
                          newConfig.constellation = sortedJson;
                      } else {
                          const configData = unwrapJson(sortedJson);
                          const type = configData?.NMS?.type;
                          
                          if (type === 'TERMINAL_LAN_OPT' || (configData?.SWITCH_PORT && configData?.VLAN_CONFIGURATIONS)) {
                              newConfig.lan = configData;
                          } else { 
                              newConfig.opt = configData;
                          }
                      }
                  } catch (err) {
                       setError(prev => `${prev ? prev + '\n' : ''}Failed to process ${file.name}: ${err.message}`);
                       newFileNames = newFileNames.filter(name => name !== file.name);
                  }
              }
          }
          
          newConfig.fileName = newFileNames.join(', ');
          setConfig(newConfig);
          setIsLoading(false);
          
          if (currentView === 'upload') {
              if (newConfig.lan) setCurrentView('lanA');
              else if (newConfig.opt) setCurrentView('optA');
              else if (newConfig.constellation) setCurrentView('constellationA');
          }

        }, [configSetA, configSetB, currentView]);

        const handleReset = (slot) => {
            const emptyState = { lan: null, opt: null, constellation: null, fileName: '' };
            if (slot === 'A') {
              setConfigSetA(emptyState);
              if (currentView.endsWith('A') || (currentView.endsWith('Compare') && !configSetB.fileName)) {
                  setCurrentView(configSetB.fileName ? 'lanB' : 'upload');
              }
            } else if (slot === 'B') {
              setConfigSetB(emptyState);
              if (currentView.endsWith('B') || (currentView.endsWith('Compare') && !configSetA.fileName)) {
                  setCurrentView(configSetA.fileName ? 'lanA' : 'upload');
              }
            } else { // 'all'
                setConfigSetA(emptyState);
                setConfigSetB(emptyState);
                setCurrentView('upload');
            }
        };

        const hasAnyConfig = configSetA.fileName || configSetB.fileName;
        const renderView = () => {
            switch (currentView) {
                case 'lanA': return configSetA.lan && <div><ModemSchematic config={configSetA.lan} /><div className="mt-8"><ConfigurationSummary config={configSetA.lan} /></div></div>;
                case 'lanB': return configSetB.lan && <div><ModemSchematic config={configSetB.lan} /><div className="mt-8"><ConfigurationSummary config={configSetB.lan} /></div></div>;
                case 'optA': return configSetA.opt && <OptConfigurationSummary config={configSetA.opt} />;
                case 'optB': return configSetB.opt && <OptConfigurationSummary config={configSetB.opt} />;
                case 'constellationA': return configSetA.constellation && <ConstellationVisualizer config={configSetA.constellation} formatLongitude={formatLongitude} />;
                case 'constellationB': return configSetB.constellation && <ConstellationVisualizer config={configSetB.constellation} formatLongitude={formatLongitude} />;
                case 'lanCompare': return <LanComparisonView configA={configSetA.lan} configB={configSetB.lan} />;
                case 'optCompare': return <ComparisonView configA={configSetA.opt} configB={configSetB.opt} configType="TERMINAL_OPT" />;
                case 'constellationCompare': return <ConstellationComparison configA={configSetA.constellation} configB={configSetB.constellation} formatLongitude={formatLongitude} />;
                default: return null;
            }
        };

        const ViewTabs = () => {
            const tabs = [
                { id: 'A', label: 'Config A' },
                { id: 'B', label: 'Config B' },
                { id: 'Compare', label: 'Compare' },
            ];
            
            const activeTab = useMemo(() => {
                if (currentView.endsWith('Compare')) return 'Compare';
                if (currentView.endsWith('B')) return 'B';
                return 'A';
            }, [currentView]);
        
            const configTypes = [
                { id: 'lan', label: 'TERMINAL_LAN_OPT' },
                { id: 'opt', label: 'TERMINAL_OPT' },
                { id: 'constellation', label: 'Constellation' },
            ];
        
            const handleTabClick = (tabId) => {
                const currentConfigTypeMatch = currentView.match(/^(lan|opt|constellation)/);
                const currentConfigType = currentConfigTypeMatch ? currentConfigTypeMatch[0] : 'lan';
                
                const configTypesInOrder = ['lan', 'opt', 'constellation'];
                const typesToCheck = [currentConfigType, ...configTypesInOrder.filter(t => t !== currentConfigType)];

                for (const type of typesToCheck) {
                    if (tabId === 'A' && configSetA[type]) {
                        setCurrentView(`${type}A`);
                        return;
                    }
                    if (tabId === 'B' && configSetB[type]) {
                        setCurrentView(`${type}B`);
                        return;
                    }
                    if (tabId === 'Compare' && configSetA[type] && configSetB[type]) {
                        setCurrentView(`${type}Compare`);
                        return;
                    }
                }
            };
        
            return (
                <div className="w-full">
                    <div className="border-b border-gray-200">
                        <nav className="-mb-px flex space-x-8" aria-label="Tabs">
                            {tabs.map(tab => (
                                <button
                                    key={tab.id}
                                    onClick={() => handleTabClick(tab.id)}
                                    className={`${activeTab === tab.id ? 'border-primary text-primary' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`}
                                >
                                    {tab.label}
                                </button>
                            ))}
                        </nav>
                    </div>
                    <div className="pt-6">
                        <div className="flex flex-wrap gap-4">
                            {configTypes.map(type => {
                                const isAvailableA = !!configSetA[type.id];
                                const isAvailableB = !!configSetB[type.id];
                                const isCompare = activeTab === 'Compare';
                                const isDisabled = isCompare ? !(isAvailableA && isAvailableB) : (activeTab === 'A' ? !isAvailableA : !isAvailableB);
                                const targetView = `${type.id}${isCompare ? 'Compare' : activeTab}`;
                                
                                const isActive = currentView.toLowerCase() === targetView.toLowerCase();

                                return (
                                    <button
                                        key={type.id + activeTab}
                                        disabled={isDisabled}
                                        onClick={() => setCurrentView(targetView)}
                                        className={`font-semibold py-2 px-4 rounded-md transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-50 ${
                                            isDisabled ? 'bg-gray-200 text-gray-400 cursor-not-allowed' :
                                            isActive ? 'bg-primary text-white shadow-md' : 'bg-white hover:bg-gray-100 text-gray-700 border border-gray-300'
                                        }`}
                                    >
                                        {type.label}
                                    </button>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        return (
          <div className="min-h-screen bg-white text-gray-800 p-4 sm:p-6 lg:p-8">
            <div className="max-w-7xl mx-auto">
              <header className="text-center mb-8 flex flex-col sm:flex-row items-center justify-center gap-4">
                <img src="https://raw.githubusercontent.com/pgarciafer/MTNblockagechart/main/logo.png" alt="MTN Logo" className="h-12" />
                <h1 className="text-3xl sm:text-4xl font-bold text-primary">
                  Modem Configuration Visualizer
                </h1>
              </header>

              <main>
                {isLoading && (
                   <div className="text-center py-12">
                      <p className="text-lg text-primary animate-pulse">Parsing configuration...</p>
                   </div>
                )}

                {!isLoading && !hasAnyConfig && (
                  <div className="mt-12">
                      <div className="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                          <FileUpload slotLabel="Configuration A" onFileUpload={(files) => handleFileUpload(files, 'A')} setError={setError} />
                          <FileUpload slotLabel="Configuration B" onFileUpload={(files) => handleFileUpload(files, 'B')} setError={setError} />
                      </div>
                  </div>
                )}
                
                {error && (
                   <div className="mt-6 max-w-4xl mx-auto bg-red-100 border border-red-300 text-red-800 px-4 py-3 rounded-lg " role="alert">
                      <strong className="font-bold">Error: </strong>
                      <pre className="mt-2 text-sm whitespace-pre-wrap">{error}</pre>
                  </div>
                )}

                {!isLoading && hasAnyConfig && (
                  <div className="space-y-8">
                    <div className="bg-white p-4 rounded-lg border border-gray-200 shadow-sm space-y-4">
                        <div className="flex flex-col md:flex-row justify-between items-start gap-4">
                           <div className="flex-1 w-full"> <FileUpload slotLabel="Configuration A" fileName={configSetA.fileName} onReset={() => handleReset('A')} onFileUpload={(files) => handleFileUpload(files, 'A')} setError={setError}/></div>
                           <div className="flex-1 w-full"> <FileUpload slotLabel="Configuration B" fileName={configSetB.fileName} onReset={() => handleReset('B')} onFileUpload={(files) => handleFileUpload(files, 'B')} setError={setError}/></div>
                        </div>
                        <div className="text-center">
                            <button
                              onClick={() => handleReset('all')}
                              className="bg-danger text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-white focus:ring-danger"
                            >
                              Reset All
                            </button>
                        </div>
                    </div>
                    
                    <ViewTabs />
                    
                    <div className="mt-6">
                      {renderView()}
                    </div>
                  </div>
                )}
              </main>
            </div>
          </div>
        );
      };

      const rootElement = document.getElementById('root');
      if (!rootElement) {
        throw new Error("Could not find root element to mount to");
      }

      const root = ReactDOM.createRoot(rootElement);
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    </script>
  </body>
</html>
